<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="clg-list-item.html">

<dom-module id="clg-departments">
  
<template>
  <style is="custom-style">
    a[selected] {
      background: pink;
    }
  </style>
  <ul>
    <template id="departments-template" is="dom-repeat" items="{{list}}">
      <li id="[[item.id]]">
        <input type="checkbox" checked="{{item.$selected::change}}">
        <a href="#departments/[[item.id]]"
           selected$="[[isEqual_(item.id, selectedItemId_)]]">[[item.name]]</a>
      </li>
    </template>
    <br>
    <input type="button" 
           value="Delete" 
           on-click="onDeleteClick"
           disabled$="[[!selectedCount_]]">
  </ul>
</template>

<script>

  'use strict';

  goog.provide('coligo.elements.Departments');

  goog.require('coligo.scripts.actions');
  goog.require('coligo.behaviors.StateAccessor');
  goog.require('coligo.behaviors.ListView');

  coligo.elements.Departments = class Departments {

    get behaviors() {
      return [
        coligo.behaviors.ListView,
        coligo.behaviors.StateAccessor
      ];
    }

    beforeRegister() {
      this.is = 'clg-departments';
      this.properties = {
        selectedCount_: {
          type: Number,
          value: 0
        },
        route: {
          type: Object,
          observer: 'onRouteChanged_'
        },
        selectedItemId_: {
          type: Number
        }
      },
      this.observers = [
        'itemChanged_(list.*)'
      ]
    }

    ready() {
    }

    pageWatcher(detail) {
      if (detail.pageSelected) {
        this.fire('dispatch-action', {
          type: coligo.scripts.actions.FETCH_DEPARTMENTS
        });
      }
      if (detail.pageDeselected) {
      }
    }

    onDeleteClick(event) {
      console.log('delete clicked');
      this.list.forEach(item => {
          if (item.$selected) {
            this.fire('dispatch-action', {
            type: coligo.scripts.actions.DELETE_DEPARTMENT,
            id: item.id
          });
        }
      });
    }

    itemChanged_(change) {
      if (change.path.endsWith('$selected')) {
        let selectedCount = 0;
        this.get('list').forEach(elem => {
          selectedCount += elem.$selected ? 1 : 0;
        });
        this.selectedCount_ = selectedCount;
      }
    }

    isEqual_(arg1, arg2) {
      return arg1 == arg2;
    }

    onRouteChanged_(route) {
      console.log('route changed: ', route);
      if (route.hash) {
        this.selectedItemId_ = Number(route.valueAt(1));
      }
    }

  };

  // Register the element using Polymer's constructor.
  Polymer(coligo.elements.Departments);

</script>

</dom-module>
