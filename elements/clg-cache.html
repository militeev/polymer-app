<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="clg-cache">
  
<template>
</template>

<script>

  'use strict';

  goog.provide('coligo.elements.Cache');

  goog.require('coligo.behaviors.StateMutator');

  coligo.elements.Cache = class Cache {

    get behaviors() {
      return [
        coligo.behaviors.StateMutator
      ];
    }

    beforeRegister() {
      this.is = 'clg-cache';
      this.properties = {
        state: {
          type: Object,
          value: {
            employees: {}
          },
          notify: true
        }
      };
    }

    ready() { 
    }

    getDepartment(id) {
      let department = this.findInArray_('state.departments', id);
      if (department) {
        this.set('state.department', department);
        return true;
      } else {
        return false;
      }
    }

    getEmployee(id) {
      return this.getCached('employees', 'state.employee', id);
    }

    gotEmployee(response) {
      if (goog.isArray(response)) {
        response.forEach(element => {
          this.addToCache('employees', element);
        })
      } else {
        this.addToCache_('employees', response);
      }
    }

    addToCache_(fieldName, object) {
      this.get(fieldName)[object.id] = object;
    }

    getCached(fieldName, modelPath, id) {
      let model = this.get(fieldName)[id];
      if (model) {
        this.set(modelPath, goog.object.unsafeClone(model));
        return true;
      } else {
        return false;
      }
    }

    findInArray_(path, id) {
      let result = undefined;
      let array = this.get(path);
      if (array && array.length) {
        result = array.find(elem => elem.id == id);
      }
      return result;
    }

  }

  // Register the element using Polymer's constructor.
  Polymer(coligo.elements.Cache);

</script>

</dom-module>
