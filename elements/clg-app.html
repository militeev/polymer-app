<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="clg-menu.html">
<link rel="import" href="clg-router.html">
<link rel="import" href="clg-departments.html">
<link rel="import" href="clg-department.html">
<link rel="import" href="clg-employees.html">
<link rel="import" href="clg-employee.html">
<link rel="import" href="clg-projects.html">
<link rel="import" href="clg-data-service.html">
<link rel="import" href="clg-cache.html">

<dom-module id="clg-app">

<template>
  <style is="custom-style">
    #main {
      display: flex;
    }
    #menu {
      width: 150px;
      border-right: gray 1px solid;
    }
    #column1, #column2 {
      width: 250px;
      border-right: gray 1px solid;
    }
  </style>
  <clg-data-service id="data-service" state="{{state}}"></clg-data-service>
  <clg-cache id="cache" state="{{state}}"></clg-cache>
  <h2>My Application</h2>
  <div id="main">
    <div id="menu">
      <clg-menu state="[[state]]"></clg-menu>
    </div>
    <div id="column1">
      <iron-pages attr-for-selected="page"
                  selected="[[state.currentPage]]"
                  on-iron-select="onPageSelect_"
                  on-iron-deselect="onPageDeselect_">
        <section page="departments">
          <h3>Departments</h3>
          <clg-departments list="[[state.departments]]"
                           route="[[state.route]]"
                           page-watcher>
          </clg-departments>
        </section>
        <section page="projects">
          <h3>Projects</h3>
          <clg-projects list="[[state.projects]]"
                        page-watcher>
          </clg-projects>
        </section>
        <section page="employees">
          <h3>Employees</h3>
          <clg-employees list="[[state.employees]]"
                         route="[[state.route]]"
                         page-watcher>
          </clg-employees>
        </section>
      </iron-pages>
    </div>
    <div id="column2">
      <clg-department route="[[state.route]]"
                      model="[[state.department]]">
      </clg-department>
      <clg-employee id="employee-view"
                    route="[[state.route]]"
                    model="[[state.employee]]">
      </clg-employee>
    </div>
  </div>
  <clg-router state="{{state}}"></clg-router>

</template>

<script>

  'use strict';

  goog.provide('coligo.elements.Application');

  goog.require('coligo.behaviors.StateAware');
  goog.require('coligo.behaviors.CacheActionDispatcher');
  goog.require('coligo.behaviors.ActionDispatcher');

  let MyBehavior = {  };
 
  coligo.elements.Application = class App {

    // Define behaviors with a getter.
    get behaviors() {
      return [
        coligo.behaviors.CacheActionDispatcher,
        coligo.behaviors.ActionDispatcher,
        coligo.behaviors.StateAware
      ];
    }

    // get listeners() {
    //   return {
    //     'state-changed': 'onStateChanged_'
    //   }
    // }

    // onStateChanged_(event, detail) {
    //   //this.$['employee-view'].fire('state-changed', detail, {bubbles: false});
    //   this.notifyStateAwareChildren(detail.path, detail.value);
    // }

    // Element setup goes in beforeRegister instead of createdCallback.
    beforeRegister() {
      this.is = 'clg-app';

      // Define the properties object in beforeRegister.
      this.properties = {
        symbols: {
          type: Array,
          value: () => []
        }
      };
    }

    // Define other lifecycle methods as you need.
    ready() { 
    }
    attached() { }
    detached() { }
    attributeChanged() { }

    onPageSelect_(event, detail) {
//       console.log('page selected');
      this.notifyWatchers(detail.item, 'page-watcher', {pageSelected: true});
    }

    notifyWatchers(parent, watcherAttribute, detail) {
      let methodName = goog.string.toCamelCase(watcherAttribute);
      Array.from(parent.querySelectorAll('[' + watcherAttribute + ']'))
          .forEach(element => {
            element[methodName](detail);
          });
    }

    onPageDeselect_(event, detail) {
      console.log('page deselected');
      this.notifyWatchers(detail.item, 'page-watcher', {pageDeselected: true});
    }

  }

  // Register the element using Polymer's constructor.
  Polymer(coligo.elements.Application);

</script>

</dom-module>
